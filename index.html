<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petualangan Kode - Belajar Berpikir Komputasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            /* Prevent pull-to-refresh and other touch actions on the body */
            overscroll-behavior-y: contain;
        }
        h1, h2, h3, .font-display {
            font-family: 'Fredoka One', cursive;
        }
        .game-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn {
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .command-block, .tappable-command {
            cursor: pointer;
            user-select: none;
        }
        .command-block:active {
            transform: scale(0.9);
        }
        .drop-zone {
            border: 3px dashed #93c5fd;
            min-height: 80px;
        }
        .toy, .ingredient {
            cursor: grab;
            touch-action: none; /* Important for touch drag */
        }
        .toy:active, .ingredient:active {
            cursor: grabbing;
        }
        .toy-box, .cauldron {
            border: 3px dashed;
        }
        .toy-box { border-color: #a78bfa; }
        .cauldron { border-color: #facc15; }
        
        /* Style for the element being dragged via touch */
        .dragging {
            position: absolute;
            z-index: 1000;
            opacity: 0.8;
            pointer-events: none; /* So it doesn't interfere with drop target detection */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 max-w-5xl">

        <!-- Header -->
        <header class="text-center p-4 md:p-6 bg-white rounded-2xl shadow-lg mb-8 border-4 border-blue-300">
            <div class="flex justify-center items-center gap-2 md:gap-4">
                <svg class="w-16 h-16 md:w-20 md:h-20 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.37,18.37a2,2,0,0,0,2.6,0l0.73-0.73a2,2,0,0,0,0-2.82L8.81,13a2,2,0,0,0-2.82,0L5.26,13.73a2,2,0,0,0,0,2.82l0.74,0.74A2,2,0,0,0,7.37,18.37ZM12,6a3.5,3.5,0,1,0,3.5,3.5A3.5,3.5,0,0,0,12,6Zm7.47,9.84a2,2,0,0,0-2.82,0l-0.74,0.74a2,2,0,0,0,0,2.82l0.73,0.73a2,2,0,0,0,2.82,0l0.73-0.73a2,2,0,0,0,0-2.82ZM18,10a2,2,0,1,0-2-2A2,2,0,0,0,18,10Zm-4.88,2.12a4.5,4.5,0,1,1,0,6.36,4.49,4.49,0,0,1-6.36,0,4.5,4.5,0,1,1,0-6.36,4.49,4.49,0,0,1,6.36,0ZM12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" fill="currentColor"/></svg>
                <div>
                    <h1 class="text-3xl md:text-5xl text-blue-600 font-display">Petualangan Kode</h1>
                    <p class="text-base md:text-lg text-gray-600 mt-2">Ayo Belajar Berpikir Sambil Bermain!</p>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-menu">
            <h2 class="text-3xl text-center text-gray-700 mb-8 font-display">Pilih Permainanmu!</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
                <!-- Game 1: Robot -->
                <div onclick="showGame('robot-game')" class="game-card bg-white p-6 rounded-2xl shadow-md text-center cursor-pointer border-4 border-green-300">
                    <div class="text-6xl mb-4">ü§ñ</div>
                    <h3 class="text-2xl font-display text-green-600">Arahkan Robot</h3>
                    <p class="text-gray-500 mt-2">Bantu robot menemukan hartanya dengan menyusun perintah. Ini melatih <strong class="text-green-700">Urutan</strong>!</p>
                </div>
                <!-- Game 2: Toys -->
                <div onclick="showGame('toys-game')" class="game-card bg-white p-6 rounded-2xl shadow-md text-center cursor-pointer border-4 border-purple-300">
                    <div class="text-6xl mb-4">üß∏</div>
                    <h3 class="text-2xl font-display text-purple-600">Sortir Mainan</h3>
                    <p class="text-gray-500 mt-2">Masukkan mainan ke kotak yang benar. Ini melatih <strong class="text-purple-700">Pengenalan Pola</strong>!</p>
                </div>
                <!-- Game 3: Recipe -->
                <div onclick="showGame('recipe-game')" class="game-card bg-white p-6 rounded-2xl shadow-md text-center cursor-pointer border-4 border-yellow-300">
                    <div class="text-6xl mb-4">üç∞</div>
                    <h3 class="text-2xl font-display text-yellow-600">Resep Kue Ajaib</h3>
                    <p class="text-gray-500 mt-2">Ikuti langkah-langkah resep untuk membuat kue. Ini melatih <strong class="text-yellow-700">Algoritma</strong>!</p>
                </div>
            </div>
        </main>

        <!-- Game Screens (Hidden by default) -->
        <div id="game-container" class="hidden">
            <!-- Robot Game -->
            <div id="robot-game" class="game-screen hidden">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border-4 border-green-300">
                    <h2 class="text-3xl text-center font-display text-green-600 mb-4">Arahkan Robot</h2>
                    <p class="text-center text-gray-600 mb-4">Ketuk perintah untuk menambahkannya. Ketuk lagi di kotak bawah untuk menghapus.</p>
                    
                    <div class="flex flex-col md:grid md:grid-cols-2 gap-6 items-start">
                        <!-- Game Board -->
                        <div class="bg-blue-100 p-4 rounded-xl w-full">
                            <div id="robot-grid" class="grid grid-cols-5 gap-1 mx-auto w-full max-w-sm aspect-square">
                                <!-- Grid cells will be generated by JS -->
                            </div>
                        </div>

                        <!-- Command Area -->
                        <div class="flex flex-col gap-4 w-full">
                            <div class="bg-gray-100 p-4 rounded-xl">
                                <h3 class="font-bold text-lg mb-2 text-gray-700">Pilih Perintah:</h3>
                                <div id="available-commands" class="flex flex-wrap gap-3 justify-center">
                                    <div class="tappable-command bg-blue-500 text-white p-3 rounded-lg shadow-md text-2xl" data-command="up">‚¨ÜÔ∏è</div>
                                    <div class="tappable-command bg-blue-500 text-white p-3 rounded-lg shadow-md text-2xl" data-command="down">‚¨áÔ∏è</div>
                                    <div class="tappable-command bg-blue-500 text-white p-3 rounded-lg shadow-md text-2xl" data-command="left">‚¨ÖÔ∏è</div>
                                    <div class="tappable-command bg-blue-500 text-white p-3 rounded-lg shadow-md text-2xl" data-command="right">‚û°Ô∏è</div>
                                </div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <h3 class="font-bold text-lg mb-2 text-blue-800">Urutan Perintahmu:</h3>
                                <div id="command-sequence" class="drop-zone p-4 rounded-lg bg-white flex flex-wrap gap-2 items-center">
                                    <!-- Tapped commands appear here -->
                                </div>
                            </div>
                            <div class="flex gap-4 mt-4">
                                <button onclick="runRobot()" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl w-full text-lg font-display">Jalankan!</button>
                                <button onclick="resetRobotGame()" class="btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl w-full text-lg font-display">Ulangi</button>
                            </div>
                        </div>
                    </div>
                    <button onclick="showMenu()" class="btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-8">Kembali ke Menu</button>
                </div>
            </div>

            <!-- Toys Game -->
            <div id="toys-game" class="game-screen hidden">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border-4 border-purple-300">
                    <h2 class="text-3xl text-center font-display text-purple-600 mb-4">Sortir Mainan</h2>
                    <p class="text-center text-gray-600 mb-4">Seret setiap mainan ke dalam kotak yang benar!</p>
                    
                    <div class="bg-purple-50 p-4 rounded-xl">
                        <div id="toys-area" class="flex justify-center flex-wrap gap-6 p-4 min-h-[120px] bg-white rounded-lg shadow-inner">
                            <!-- Toys will be generated by JS -->
                        </div>
                    </div>

                    <div id="toy-boxes-area" class="mt-8 grid grid-cols-2 gap-4">
                        <!-- Toy boxes will be generated by JS -->
                    </div>
                    <button onclick="showMenu()" class="btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-8">Kembali ke Menu</button>
                </div>
            </div>

            <!-- Recipe Game -->
            <div id="recipe-game" class="game-screen hidden">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border-4 border-yellow-300">
                    <h2 class="text-3xl text-center font-display text-yellow-600 mb-4">Resep Kue Ajaib</h2>
                    <p class="text-center text-gray-600 mb-4">Ikuti resep! Seret bahan ke mangkuk.</p>
                    
                    <div class="flex flex-col md:grid md:grid-cols-3 gap-6">
                        <!-- Recipe Steps -->
                        <div class="bg-yellow-50 p-4 rounded-xl">
                            <h3 class="font-bold text-lg mb-2 text-yellow-800">Langkah Resep:</h3>
                            <ul id="recipe-steps" class="list-decimal list-inside space-y-2 text-gray-700">
                                <!-- Steps will be generated by JS -->
                            </ul>
                        </div>

                        <!-- Ingredients -->
                        <div class="bg-gray-100 p-4 rounded-xl">
                             <h3 class="font-bold text-lg mb-2 text-gray-700">Bahan-bahan:</h3>
                             <div id="ingredients-area" class="flex flex-wrap gap-4 justify-center">
                                <!-- Ingredients will be generated by JS -->
                             </div>
                        </div>

                        <!-- Cauldron -->
                        <div class="flex flex-col items-center justify-center bg-yellow-100 p-4 rounded-xl">
                             <h3 class="font-bold text-lg mb-2 text-yellow-800">Mangkuk Ajaib</h3>
                             <div id="cauldron" class="cauldron w-40 h-40 md:w-48 md:h-48 bg-white rounded-full flex items-center justify-center text-6xl shadow-inner">
                               ü•£
                             </div>
                             <div id="cake-result" class="mt-4 text-6xl"></div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="resetRecipeGame()" class="btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl mt-6 text-lg font-display">Buat Kue Lagi!</button>
                        <button onclick="showMenu()" class="btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-6">Kembali ke Menu</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="modal" class="fixed inset-0 modal-backdrop hidden z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm mx-4 border-8 transform transition-all" id="modal-content">
                <!-- Modal content will be injected here -->
            </div>
        </div>

    </div>

    <script>
        // --- Sound Engine ---
        const synth = new Tone.Synth().toDestination();
        const sounds = {
            success: () => synth.triggerAttackRelease("C5", "8n"),
            failure: () => synth.triggerAttackRelease("C3", "8n"),
            click: () => synth.triggerAttackRelease("C4", "16n"),
            drop: () => synth.triggerAttackRelease("E4", "16n"),
            win: () => {
                const now = Tone.now();
                const startTime = now + 0.01;
                synth.triggerAttackRelease("C5", "8n", startTime);
                synth.triggerAttackRelease("E5", "8n", startTime + 0.2);
                synth.triggerAttackRelease("G5", "8n", startTime + 0.4);
            }
        };

        // --- Global State & Navigation ---
        const mainMenu = document.getElementById('main-menu');
        const gameContainer = document.getElementById('game-container');
        const gameScreens = document.querySelectorAll('.game-screen');

        function showGame(gameId) {
            sounds.click();
            mainMenu.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            gameScreens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(gameId).classList.remove('hidden');
            
            if (gameId === 'robot-game') initRobotGame();
            if (gameId === 'toys-game') initToysGame();
            if (gameId === 'recipe-game') initRecipeGame();
        }

        function showMenu() {
            sounds.click();
            mainMenu.classList.remove('hidden');
            gameContainer.classList.add('hidden');
        }

        // --- Modal ---
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');

        function showModal(emoji, title, message, buttonText, onButtonClick) {
            modalContent.innerHTML = `
                <div class="text-8xl mb-4">${emoji}</div>
                <h3 class="text-3xl font-display text-blue-600 mb-2">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <button id="modal-button" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl text-lg font-display">${buttonText}</button>
            `;
            modal.classList.remove('hidden');
            document.getElementById('modal-button').onclick = () => {
                sounds.click();
                modal.classList.add('hidden');
                if (onButtonClick) onButtonClick();
            };
        }

        // --- Game 1: Robot Game (Now with Tap Controls) ---
        const robotGrid = document.getElementById('robot-grid');
        const commandSequence = document.getElementById('command-sequence');
        const availableCommands = document.getElementById('available-commands');
        let robotPos = { x: 0, y: 0 };
        let gemPos = { x: 0, y: 0 };
        const gridSize = 5;

        function initRobotGame() {
            robotGrid.innerHTML = '';
            commandSequence.innerHTML = '';
            
            for (let i = 0; i < gridSize * gridSize; i++) {
                const cell = document.createElement('div');
                cell.classList.add('w-full', 'h-full', 'bg-blue-200', 'rounded-md', 'flex', 'items-center', 'justify-center', 'text-2xl', 'md:text-3xl');
                robotGrid.appendChild(cell);
            }
            
            do {
                robotPos = { x: Math.floor(Math.random() * gridSize), y: Math.floor(Math.random() * gridSize) };
                gemPos = { x: Math.floor(Math.random() * gridSize), y: Math.floor(Math.random() * gridSize) };
            } while (robotPos.x === gemPos.x && robotPos.y === gemPos.y);

            drawRobotGrid();
        }

        // Add tap listeners for robot game
        availableCommands.addEventListener('click', e => {
            if (e.target.classList.contains('tappable-command')) {
                sounds.click();
                const command = e.target.dataset.command;
                const newBlock = document.createElement('div');
                newBlock.classList.add('command-block', 'bg-blue-500', 'text-white', 'p-3', 'rounded-lg', 'shadow-md', 'text-2xl');
                newBlock.dataset.command = command;
                newBlock.textContent = e.target.textContent;
                commandSequence.appendChild(newBlock);
            }
        });

        commandSequence.addEventListener('click', e => {
            if (e.target.classList.contains('command-block')) {
                sounds.failure();
                e.target.remove();
            }
        });
        
        function drawRobotGrid() {
            const cells = robotGrid.children;
            for (let i = 0; i < cells.length; i++) cells[i].textContent = '';
            cells[robotPos.y * gridSize + robotPos.x].textContent = 'ü§ñ';
            cells[gemPos.y * gridSize + gemPos.x].textContent = 'üíé';
        }

        function runRobot() {
            const userSequence = Array.from(commandSequence.children).map(el => el.dataset.command);
            let currentPos = { ...robotPos };
            let path = [currentPos];
            userSequence.forEach(cmd => {
                if (cmd === 'up') currentPos.y--;
                if (cmd === 'down') currentPos.y++;
                if (cmd === 'left') currentPos.x--;
                if (cmd === 'right') currentPos.x++;
                path.push({ ...currentPos });
            });
            animateRobot(path);
        }

        function animateRobot(path) {
            let step = 0;
            const interval = setInterval(() => {
                if (step < path.length) {
                    const pos = path[step];
                    const cells = robotGrid.children;
                    for (let i = 0; i < cells.length; i++) {
                        if (cells[i].textContent === 'ü§ñ') cells[i].textContent = '';
                    }
                    if(pos.x >= 0 && pos.x < gridSize && pos.y >= 0 && pos.y < gridSize) {
                       cells[pos.y * gridSize + pos.x].textContent = 'ü§ñ';
                    }
                    step++;
                } else {
                    clearInterval(interval);
                    checkRobotWin(path[path.length - 1]);
                }
            }, 400);
        }
        
        function checkRobotWin(finalPos) {
            if (finalPos.x === gemPos.x && finalPos.y === gemPos.y) {
                sounds.win();
                showModal('üéâ', 'Berhasil!', 'Kamu hebat! Robotnya sampai ke tujuan.', 'Main Lagi', resetRobotGame);
            } else {
                sounds.failure();
                showModal('üò•', 'Oh tidak!', 'Robotnya tersesat. Coba periksa lagi urutan perintahmu!', 'Coba Lagi', () => {
                   drawRobotGrid();
                });
            }
        }

        function resetRobotGame() {
            initRobotGame();
        }

        // --- Generic Drag and Drop Logic (for Mouse and Touch) ---
        function enableDragAndDrop(dragContainer, dropContainers, onDrop) {
            let draggedItem = null;
            let clone = null;
            let startX, startY;

            // Mouse Events
            dragContainer.addEventListener('dragstart', e => {
                if (e.target.dataset.drag) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('hidden'), 0);
                }
            });

            dragContainer.addEventListener('dragend', e => {
                if (draggedItem) {
                    draggedItem.classList.remove('hidden');
                    draggedItem = null;
                }
            });

            dropContainers.forEach(container => {
                container.addEventListener('dragover', e => e.preventDefault());
                container.addEventListener('drop', e => {
                    e.preventDefault();
                    if (draggedItem) onDrop(draggedItem, container);
                });
            });

            // Touch Events
            dragContainer.addEventListener('touchstart', e => {
                if (e.target.dataset.drag) {
                    draggedItem = e.target;
                    clone = draggedItem.cloneNode(true);
                    clone.classList.add('dragging');
                    document.body.appendChild(clone);
                    
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                    
                    clone.style.left = `${touch.clientX - clone.offsetWidth / 2}px`;
                    clone.style.top = `${touch.clientY - clone.offsetHeight / 2}px`;
                    draggedItem.style.opacity = '0.5';
                }
            });

            dragContainer.addEventListener('touchmove', e => {
                if (draggedItem && clone) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    clone.style.left = `${touch.clientX - clone.offsetWidth / 2}px`;
                    clone.style.top = `${touch.clientY - clone.offsetHeight / 2}px`;
                }
            });

            dragContainer.addEventListener('touchend', e => {
                if (draggedItem && clone) {
                    clone.style.display = 'none';
                    const endElement = document.elementFromPoint(
                        e.changedTouches[0].clientX,
                        e.changedTouches[0].clientY
                    );
                    clone.remove();

                    let dropTarget = endElement;
                    while(dropTarget && !dropTarget.dataset.drop) {
                        dropTarget = dropTarget.parentElement;
                    }

                    if (dropTarget) {
                        onDrop(draggedItem, dropTarget);
                    }
                    
                    draggedItem.style.opacity = '1';
                    draggedItem = null;
                    clone = null;
                }
            });
        }

        // --- Game 2: Toys Game ---
        const toysArea = document.getElementById('toys-area');
        const toyBoxesArea = document.getElementById('toy-boxes-area');
        const toyTypes = [
            { shape: 'bola', emoji: '‚öΩ', boxEmoji: 'ü•Ö' },
            { shape: 'mobil', emoji: 'üöó', boxEmoji: 'üè†' },
            { shape: 'boneka', emoji: 'üß∏', boxEmoji: 'üõèÔ∏è' },
            { shape: 'balok', emoji: 'üß±', boxEmoji: 'üì¶' }
        ];

        function initToysGame() {
            toysArea.innerHTML = '';
            toyBoxesArea.innerHTML = '';
            
            const toysToSort = [...toyTypes, ...toyTypes].sort(() => 0.5 - Math.random());
            toysToSort.forEach((toy, index) => {
                const toyEl = document.createElement('div');
                toyEl.classList.add('toy', 'text-5xl', 'p-2');
                toyEl.textContent = toy.emoji;
                toyEl.draggable = true;
                toyEl.dataset.drag = 'toy';
                toyEl.dataset.shape = toy.shape;
                toysArea.appendChild(toyEl);
            });

            toyTypes.forEach(type => {
                const boxEl = document.createElement('div');
                boxEl.classList.add('toy-box', 'p-6', 'rounded-xl', 'bg-purple-100', 'flex', 'flex-col', 'items-center', 'justify-center');
                boxEl.dataset.drop = 'toy-box';
                boxEl.dataset.shape = type.shape;
                boxEl.innerHTML = `<div class="text-6xl mb-2 pointer-events-none">${type.boxEmoji}</div><div class="font-bold text-purple-800 pointer-events-none">Kotak ${type.shape}</div>`;
                toyBoxesArea.appendChild(boxEl);
            });

            enableDragAndDrop(toysArea, Array.from(toyBoxesArea.children), (toy, box) => {
                if (box.dataset.shape === toy.dataset.shape) {
                    sounds.success();
                    toy.remove();
                    if (toysArea.children.length === 0) {
                        sounds.win();
                        showModal('üèÜ', 'Hore!', 'Semua mainan sudah rapi!', 'Main Lagi', initToysGame);
                    }
                } else {
                    sounds.failure();
                }
            });
        }
        
        // --- Game 3: Recipe Game ---
        const recipeStepsEl = document.getElementById('recipe-steps');
        const ingredientsArea = document.getElementById('ingredients-area');
        const cauldronEl = document.getElementById('cauldron');
        const cakeResultEl = document.getElementById('cake-result');
        const recipe = [
            { name: 'Tepung', emoji: 'üçö' }, { name: 'Telur', emoji: 'ü•ö' },
            { name: 'Gula', emoji: 'üç¨' }, { name: 'Susu', emoji: 'ü•õ' },
        ];
        let currentStep = 0;

        function initRecipeGame() {
            currentStep = 0;
            cakeResultEl.textContent = '';
            cauldronEl.innerHTML = 'ü•£';
            cauldronEl.dataset.drop = 'cauldron';
            
            recipeStepsEl.innerHTML = '';
            recipe.forEach(step => {
                recipeStepsEl.innerHTML += `<li data-name="${step.name}">Masukkan ${step.name}</li>`;
            });
            updateRecipeStepsUI();

            ingredientsArea.innerHTML = '';
            const shuffledIngredients = [...recipe].sort(() => 0.5 - Math.random());
            shuffledIngredients.forEach(ing => {
                const el = document.createElement('div');
                el.classList.add('ingredient', 'text-5xl', 'p-3', 'bg-white', 'rounded-lg', 'shadow');
                el.textContent = ing.emoji;
                el.draggable = true;
                el.dataset.drag = 'ingredient';
                el.dataset.name = ing.name;
                ingredientsArea.appendChild(el);
            });
            
            enableDragAndDrop(ingredientsArea, [cauldronEl], (ingredient, cauldron) => {
                 const correctIngredient = recipe[currentStep];
                 if (ingredient.dataset.name === correctIngredient.name) {
                    sounds.success();
                    currentStep++;
                    updateRecipeStepsUI();
                    ingredient.draggable = false;
                    ingredient.style.opacity = '0.5';
                    
                    if (currentStep === recipe.length) {
                        sounds.win();
                        cauldronEl.textContent = '‚ú®';
                        cakeResultEl.textContent = 'üéÇ';
                        showModal('üéÇ', 'Yummy!', 'Kue ajaib berhasil dibuat!', 'Buat Lagi', initRecipeGame);
                    }
                } else {
                    sounds.failure();
                    showModal('ü§®', 'Hmm...', 'Bukan bahan yang benar. Coba lihat resepnya!', 'Oke');
                }
            });
        }
        
        function updateRecipeStepsUI() {
            const steps = recipeStepsEl.children;
            for(let i=0; i < steps.length; i++) {
                steps[i].classList.remove('font-bold', 'text-yellow-800', 'line-through', 'text-gray-400');
                if (i < currentStep) {
                    steps[i].classList.add('line-through', 'text-gray-400');
                } else if (i === currentStep) {
                    steps[i].classList.add('font-bold', 'text-yellow-800');
                }
            }
        }
        
        function resetRecipeGame() { initRecipeGame(); }

        // --- Initial Load ---
        window.onload = () => {
            document.body.addEventListener('click', () => Tone.start(), { once: true });
        };
    </script>
</body>
</html>
